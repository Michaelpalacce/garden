name: Release
on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Type of release"
        required: true
        default: "minor"
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  tag:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      id-token: write
      contents: write
      repository-projects: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: "${{ secrets.PAT }}"

      - name: Configure Git
        run: |
          git config user.name "Github Action"
          git config user.email "github-action@users.noreply.github.com"

      - name: Calculate and Push New Tag
        run: |
          # 1. Get the latest tag, default to v0.0.0 if none exist
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Current tag: $LATEST_TAG"

          # 2. Parse the version (stripping the 'v' prefix)
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # 3. Increment based on input
          case "${{ github.event.inputs.release_type }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_TAG="v$MAJOR.$MINOR.$PATCH"
          echo "New tag: $NEW_TAG"

          git tag $NEW_TAG
          git push origin $NEW_TAG
