name: Release
on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Type of release"
        required: true
        default: "minor"
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  tag:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      id-token: write
      contents: write
      repository-projects: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - uses: oleksiyrudenko/gha-git-credentials@v2-latest
        with:
          token: "${{ secrets.PAT }}"

      - name: Calculate and Push New Tag
        run: |
          # 1. Get the latest tag, default to v0.0.0 if none exist
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Current tag: $LATEST_TAG"

          # 2. Parse the version (stripping the 'v' prefix)
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # 3. Increment based on input
          case "${{ github.event.inputs.release_type }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_TAG="v$MAJOR.$MINOR.$PATCH"
          echo "New tag: $NEW_TAG"

          git tag $NEW_TAG

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          # Using a PAT beacuse if we use GITHUB_TOKEN the Docker action will not trigger
          github_token: ${{ secrets.PAT }}
          branch: ${{ github.ref }}
          tags: true
